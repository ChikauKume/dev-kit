# E2Eシナリオ仕様書

## 概要

この仕様書は、`design.md` にE2Eテストシナリオを記載するための標準フォーマットを定義します。

## 目的

1. **Single Source of Truth**: design.md がE2Eシナリオの唯一の情報源となる
2. **AI自動生成**: 定義されたシナリオから Playwright スクリプトを自動生成する
3. **一貫性**: 全てのspecで統一されたフォーマットを使用する

---

## design.md への追加セクション

design.md の**末尾**に以下のセクションを追加します：

```markdown
## E2Eテストシナリオ

### シナリオ一覧

以下のE2Eシナリオを実装します。各シナリオは独立して実行可能です。

#### E2E-001: ユーザー登録フロー（正常系）

**目的**: 新規ユーザーが正常に登録できることを確認

**前提条件**:
- データベースがクリーンな状態
- テスト用メールアドレスが未登録

**ステップ**:
1. `/signup` にアクセス
2. フォームに以下を入力:
   - 名前: "山田 太郎"
   - メールアドレス: "test.{timestamp}@example.com"
   - 電話番号: "08012345678"
   - パスワード: "Password123!"
   - パスワード（確認）: "Password123!"
   - 利用規約: チェック
3. 「登録内容を確認」ボタンをクリック
4. `/signup/confirm` に遷移することを確認
5. 確認画面で以下を確認:
   - 名前: "山田 太郎"
   - メールアドレス: 入力したアドレス
   - 電話番号: "08012345678"
   - パスワードが表示されていないこと
6. 「登録する」ボタンをクリック
7. `/signup/complete` に遷移することを確認
8. 登録完了メッセージが表示されることを確認

**期待結果**:
- ユーザーがデータベースに作成される
- 自動ログインされる
- セッションにユーザー情報が保存される

**検証項目**:
- [ ] 各画面への遷移が正常
- [ ] 入力データが確認画面に正しく表示される
- [ ] データベースにユーザーが作成される
- [ ] パスワードがハッシュ化されて保存される

---

#### E2E-002: ログイン・ログアウトフロー（正常系）

**目的**: ログインとログアウトが正常に動作することを確認

**前提条件**:
- テスト用ユーザーが登録済み
  - メール: "existing@example.com"
  - パスワード: "Password123!"

**ステップ**:
1. `/login` にアクセス
2. フォームに入力:
   - メールアドレス: "existing@example.com"
   - パスワード: "Password123!"
3. 「ログイン」ボタンをクリック
4. `/dashboard` に遷移することを確認
5. ダッシュボードにユーザー名が表示されることを確認
6. ユーザーメニューから「ログアウト」をクリック
7. `/login` にリダイレクトされることを確認
8. セッションが無効化されたことを確認（`/dashboard` に直接アクセスすると `/login` にリダイレクト）

**期待結果**:
- ログインが成功する
- ダッシュボードが表示される
- ログアウト後セッションが破棄される

**検証項目**:
- [ ] ログイン成功後にダッシュボードが表示される
- [ ] ダッシュボードにユーザー名が表示される
- [ ] ログアウト後にログインページにリダイレクトされる
- [ ] ログアウト後に認証ページにアクセスできない

---

#### E2E-003: バリデーションエラー表示（異常系）

**目的**: フロントエンド・バックエンドのバリデーションが正常に動作することを確認

**前提条件**:
- なし

**ステップ**:
1. `/signup` にアクセス
2. フォームに以下を入力（意図的に無効なデータ）:
   - 名前: "A"（2文字未満）
   - メールアドレス: "invalid-email"（メール形式でない）
   - パスワード: "123"（8文字未満）
   - パスワード（確認）: "456"（不一致）
   - 利用規約: チェックしない
3. 「登録内容を確認」ボタンをクリック
4. 各フィールド下にエラーメッセージが表示されることを確認:
   - 名前: "名前は2文字以上で入力してください"
   - メールアドレス: "メールアドレスの形式が正しくありません"
   - パスワード: "パスワードは8文字以上で入力してください"
   - パスワード（確認）: "パスワードが一致しません"
   - 利用規約: "利用規約に同意してください"
5. `/signup` のまま遷移しないことを確認

**期待結果**:
- フロントエンドバリデーションが動作する
- エラーメッセージが日本語で表示される
- ページ遷移が発生しない

**検証項目**:
- [ ] 各フィールドのエラーメッセージが表示される
- [ ] エラーメッセージが日本語で正しい内容
- [ ] ページが `/signup` のまま変わらない
```

---

## E2Eシナリオフォーマット定義

### 必須項目

各E2Eシナリオには以下の項目を含めること：

```markdown
#### E2E-{番号}: {シナリオ名}（{正常系|異常系}）

**目的**: {テストの目的を1行で記述}

**前提条件**:
- {箇条書きで前提条件を列挙}

**ステップ**:
1. {具体的な操作手順}
2. ...

**期待結果**:
- {箇条書きで期待される結果を列挙}

**検証項目**:
- [ ] {チェックリスト形式で検証項目を列挙}
```

### フィールド説明

| フィールド | 説明 | 例 |
|-----------|------|---|
| **番号** | E2E-001 形式の連番 | E2E-001, E2E-002 |
| **シナリオ名** | 日本語でテスト内容を簡潔に | "ユーザー登録フロー" |
| **正常系/異常系** | テスト種別 | 正常系、異常系 |
| **目的** | なぜこのテストが必要か | "新規ユーザーが正常に登録できることを確認" |
| **前提条件** | テスト実行前に満たすべき条件 | "データベースがクリーンな状態" |
| **ステップ** | 具体的な操作手順（番号付きリスト） | "1. `/signup` にアクセス" |
| **期待結果** | テスト成功時に期待される結果 | "ユーザーがデータベースに作成される" |
| **検証項目** | チェックリスト形式の検証項目 | "- [ ] 各画面への遷移が正常" |

---

## 自動生成システム要件

### 入力

- `design.md` ファイルパス
- spec名（例: user-authentication）

### 処理

1. design.md から「## E2Eテストシナリオ」セクションを抽出
2. 各シナリオ（`#### E2E-{番号}`）をパース
3. ステップを Playwright コマンドに変換
4. `tests/e2e/{spec名}/` ディレクトリにスクリプト生成

### 出力

- `tests/e2e/{spec名}/e2e-{番号}.spec.ts`
- 各ファイルは独立して実行可能
- 共通ヘルパー関数は `tests/e2e/helpers/` に配置

---

## ステップからPlaywrightコマンドへの変換ルール

### URL遷移

| design.md ステップ | Playwright コマンド |
|-------------------|-------------------|
| "`{URL}` にアクセス" | `await page.goto('{URL}')` |
| "`{URL}` に遷移することを確認" | `await expect(page).toHaveURL('{URL}')` |
| "`{URL}` にリダイレクトされることを確認" | `await expect(page).toHaveURL('{URL}')` |

### フォーム操作

| design.md ステップ | Playwright コマンド |
|-------------------|-------------------|
| "{フィールド名}: \"{値}\"" | `await page.fill('input[name="{field}"]', '{値}')` |
| "{チェックボックス}: チェック" | `await page.check('input[name="{field}"]')` |
| "「{ボタン名}」ボタンをクリック" | `await page.click('button:has-text("{ボタン名}")')` |

### 検証

| design.md ステップ | Playwright コマンド |
|-------------------|-------------------|
| "{テキスト}が表示されることを確認" | `await expect(page.locator('text={テキスト}')).toBeVisible()` |
| "{テキスト}が表示されていないこと" | `await expect(page.locator('text={テキスト}')).not.toBeVisible()` |
| "エラーメッセージが表示される" | `await expect(page.locator('.form-error')).toBeVisible()` |

---

## 実装例

### design.md（E2Eシナリオセクション）

```markdown
## E2Eテストシナリオ

#### E2E-001: ユーザー登録フロー（正常系）

**目的**: 新規ユーザーが正常に登録できることを確認

**ステップ**:
1. `/signup` にアクセス
2. 名前: "山田 太郎"
3. メールアドレス: "test@example.com"
4. 「登録内容を確認」ボタンをクリック
5. `/signup/confirm` に遷移することを確認
```

### 生成される Playwright スクリプト

```typescript
// tests/e2e/user-authentication/e2e-001.spec.ts
import { test, expect } from '@playwright/test';

test.describe('E2E-001: ユーザー登録フロー（正常系）', () => {
  test('should complete user registration successfully', async ({ page }) => {
    // Step 1: `/signup` にアクセス
    await page.goto('/signup');

    // Step 2-3: フォーム入力
    await page.fill('input[name="name"]', '山田 太郎');
    await page.fill('input[name="email"]', 'test@example.com');

    // Step 4: 「登録内容を確認」ボタンをクリック
    await page.click('button:has-text("登録内容を確認")');

    // Step 5: `/signup/confirm` に遷移することを確認
    await expect(page).toHaveURL('/signup/confirm');
  });
});
```

---

## 実装フェーズ

### Phase 1: 仕様策定（本ドキュメント）✅

- E2Eシナリオフォーマット定義
- design.md セクション仕様
- 変換ルール策定

### Phase 2: パーサー実装

- design.md からE2Eシナリオを抽出
- 構造化データに変換（JSON）

### Phase 3: コードジェネレーター実装

- ステップをPlaywrightコマンドに変換
- TypeScript コード生成

### Phase 4: 統合・検証

- 既存specで動作検証
- エラーハンドリング実装
- ドキュメント整備

---

## 参考

- **Playwright公式ドキュメント**: https://playwright.dev/
- **本プロジェクトのPlaywright設定**: `playwright.config.ts`
- **テストディレクトリ**: `tests/e2e/`
