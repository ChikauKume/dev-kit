# ユーザーワークフロー（業務フロー）

## 概要

このドキュメントでは、授業動画配信プラットフォームにおけるユーザーの具体的な利用フローを定義します。product.mdに基づき、各ユーザー種別の主要なワークフローを詳細に記述しています。

## 対象ユーザー

### 一般ユーザー（受講者）
- メイン機能の視聴を目的とする利用者
- 自由に登録可能
- 全ての公開動画にアクセス可能

### 管理者（教育機関運営者・講師）
- 動画コンテンツ管理を行う
- システム全体の運用を担当
- ユーザー管理・動画管理・カテゴリ管理の権限を持つ

## 主要ワークフロー

## 1. 一般ユーザーのワークフロー

### 1.1. ユーザー登録・ログインフロー

**要件ID:** REQ-1-1, REQ-1-2

```
【新規ユーザー登録】
1. トップページ（/）アクセス
2. 「新規登録」ボタンクリック → 登録ページ（/register）へ遷移
3. 登録フォーム入力
   - 名前（必須、最大255文字）
   - メールアドレス（必須、メールアドレス形式）
   - パスワード（必須、8文字以上、英数字混在）
   - プロフィール画像（任意、JPEG/PNG形式、最大5MB）
4. 「登録」ボタンクリック
5. バリデーション実行
   - メールアドレス重複チェック
   - パスワード強度チェック
   - 画像ファイル形式・サイズチェック
6. 登録完了 → 自動ログイン処理
7. ダッシュボード（/dashboard）へ遷移

【既存ユーザーログイン】
1. トップページ（/）アクセス
2. 「ログイン」ボタンクリック → ログインページ（/login）へ遷移
3. ログインフォーム入力
   - メールアドレス（必須）
   - パスワード（必須）
4. 「ログイン」ボタンクリック
5. 認証処理（メールアドレスとパスワードで認証）
6. ログイン成功 → セッション生成（有効期限24時間）
7. ダッシュボード（/dashboard）へ遷移

【認証エラー時】
- メールアドレスまたはパスワードが間違っている場合
  → エラーメッセージ表示「メールアドレスまたはパスワードが正しくありません」
  → ログインページに留まる
- アカウントが存在しない場合
  → エラーメッセージ表示「アカウントが見つかりません」
  → ログインページに留まる
```

### 1.2. 動画視聴フロー

**要件ID:** REQ-3-1, REQ-3-2

```
【動画一覧表示・検索】
1. ダッシュボード（/dashboard）から「動画一覧」クリック
2. 動画一覧ページ（/videos）へ遷移
3. グリッド表示（サムネイル、タイトル、視聴回数、アップロード日）
4. ソート選択（新着順、人気順）
5. フィルタリング
   - カテゴリフィルター選択
   - タグフィルター選択
   - キーワード検索（タイトルによる検索）
6. ページネーション（1ページ20件）で次のページへ

【動画視聴】
1. 動画一覧から動画サムネイルをクリック
2. 動画詳細ページ（/videos/{id}）へ遷移
3. 動画プレーヤー表示（HTML5標準プレーヤー）
   - 再生/一時停止
   - 音量調整
   - 全画面表示
   - シークバー操作
4. 動画情報表示
   - タイトル
   - 説明文
   - アップロード日
   - 視聴回数（自動インクリメント）
   - カテゴリ・タグ表示
5. 関連動画表示（同じカテゴリ・タグの動画、最大5件）
6. 視聴開始時に視聴履歴を自動記録
   - ユーザーID
   - 動画ID
   - 視聴開始日時
   - 視聴時間
7. 関連動画クリックで別の動画へ遷移
```

### 1.3. プロフィール管理フロー

**要件ID:** REQ-1-3

```
【プロフィール表示】
1. ダッシュボードまたはヘッダーから「プロフィール」クリック
2. プロフィールページ（/profile）へ遷移
3. プロフィール情報表示
   - 名前
   - メールアドレス
   - プロフィール画像
4. 視聴履歴一覧表示
   - 動画タイトル
   - 視聴日時
   - 視聴時間
   - 視聴日時順にソート
5. 履歴から動画へ直接アクセス可能

【プロフィール編集】
1. プロフィールページから「編集」ボタンクリック
2. プロフィール編集ページ（/profile/edit）へ遷移
3. 編集フォーム表示
   - 名前（変更可能）
   - プロフィール画像（変更可能、JPEG/PNG形式、最大5MB）
4. 「保存」ボタンクリック
5. バリデーション実行
   - 名前必須チェック
   - 画像ファイル形式・サイズチェック
6. 保存成功 → プロフィールページへリダイレクト

【パスワード変更】
1. プロフィールページから「パスワード変更」ボタンクリック
2. パスワード変更ページ（/profile/password）へ遷移
3. パスワード変更フォーム入力
   - 現在のパスワード（必須、認証用）
   - 新しいパスワード（必須、8文字以上、英数字混在）
   - 新しいパスワード（確認用、必須）
4. 「変更」ボタンクリック
5. バリデーション実行
   - 現在のパスワード正確性チェック
   - 新しいパスワード強度チェック
   - パスワード確認一致チェック
6. 変更成功 → プロフィールページへリダイレクト
```

## 2. 管理者のワークフロー

### 2.1. 管理者ログインフロー

**要件ID:** REQ-1-2

```
【管理者ログイン】
1. 管理者ログインページ（/admin/login）アクセス
2. ログインフォーム入力
   - メールアドレス（必須）
   - パスワード（必須）
3. 「ログイン」ボタンクリック
4. 認証処理（メールアドレス、パスワード、ロール確認）
5. ロールチェック（管理者権限確認）
6. ログイン成功 → セッション生成（有効期限24時間）
7. 管理者ダッシュボード（/admin/dashboard）へ遷移

【認証・認可エラー時】
- メールアドレスまたはパスワードが間違っている場合
  → エラーメッセージ表示「メールアドレスまたはパスワードが正しくありません」
- 管理者権限がない場合
  → 前の画面にリダイレクト（権限エラーメッセージなし）
```

### 2.2. 動画アップロード・管理フロー

**要件ID:** REQ-2-1, REQ-2-2

```
【動画アップロード】
1. 管理者ダッシュボードから「動画アップロード」クリック
2. 動画アップロードページ（/admin/videos/create）へ遷移
3. アップロードフォーム入力
   - 動画ファイル（必須、MP4形式、最大2GB）
   - タイトル（必須、最大255文字）
   - 説明文（任意、最大5000文字）
   - カテゴリ選択（必須、ドロップダウン）
   - タグ入力（任意、複数可、カンマ区切り）
   - サムネイル画像（必須、JPEG/PNG形式、最大5MB）
4. 「アップロード」ボタンクリック
5. バリデーション実行
   - ファイル形式チェック（MP4のみ）
   - ファイルサイズチェック（最大2GB）
   - サムネイル形式・サイズチェック
6. ストレージへ保存（Laravel Storage）
7. データベース登録（自動的に「公開」状態）
8. アップロード成功 → 動画管理ページへリダイレクト

【動画管理（一覧表示）】
1. 管理者ダッシュボードから「動画管理」クリック
2. 動画管理ページ（/admin/videos）へ遷移
3. 動画一覧表示
   - サムネイル
   - タイトル
   - アップロード日
   - 公開状態（公開/非公開）
   - 視聴回数
   - 操作ボタン（編集/削除/公開切替）
4. ページネーション対応

【動画編集】
1. 動画管理ページから「編集」ボタンクリック
2. 動画編集ページ（/admin/videos/{id}/edit）へ遷移
3. 編集フォーム表示（既存データ表示）
   - タイトル（変更可能）
   - 説明文（変更可能）
   - カテゴリ（変更可能）
   - タグ（変更可能）
   - サムネイル画像（変更可能）
   - 動画ファイル再アップロード（オプション）
4. 「保存」ボタンクリック
5. バリデーション実行
6. 更新成功 → 動画管理ページへリダイレクト

【動画削除】
1. 動画管理ページから「削除」ボタンクリック
2. 削除確認ダイアログ表示「この動画を削除してもよろしいですか？」
3. 「削除」ボタンクリック
4. 動画ファイルとデータベース記録の完全削除
5. 関連する視聴履歴も削除
6. 削除成功 → 動画管理ページに留まる

【公開/非公開切替】
1. 動画管理ページから公開状態切替ボタンクリック
2. Ajax処理で即座に状態切替
3. 非公開にすると一般ユーザーから非表示
4. 画面リロードなしで状態表示更新
```

### 2.3. カテゴリ・タグ管理フロー

**要件ID:** REQ-2-3

```
【カテゴリ管理】
1. 管理者ダッシュボードから「カテゴリ管理」クリック
2. カテゴリ管理ページ（/admin/categories）へ遷移
3. カテゴリ一覧表示
   - カテゴリ名
   - 説明
   - 表示順
   - 操作ボタン（編集/削除）

【カテゴリ追加】
1. カテゴリ管理ページから「新規追加」ボタンクリック
2. カテゴリ追加フォーム表示
   - カテゴリ名（必須）
   - 説明（任意）
   - 表示順（必須、数値）
3. 「保存」ボタンクリック
4. バリデーション実行
5. 保存成功 → カテゴリ管理ページへリダイレクト

【カテゴリ編集】
1. カテゴリ管理ページから「編集」ボタンクリック
2. カテゴリ編集フォーム表示
3. 編集・保存
4. 更新成功 → カテゴリ管理ページへリダイレクト

【カテゴリ削除】
1. カテゴリ管理ページから「削除」ボタンクリック
2. 紐づく動画がない場合のみ削除可能
   - 紐づく動画がある場合: エラーメッセージ表示「このカテゴリに紐づく動画があるため削除できません」
   - 紐づく動画がない場合: 削除確認ダイアログ表示
3. 「削除」ボタンクリック
4. 削除成功 → カテゴリ管理ページに留まる

【タグ管理】
（カテゴリ管理と同様のフロー）
1. 管理者ダッシュボードから「タグ管理」クリック
2. タグ管理ページ（/admin/tags）へ遷移
3. タグ一覧表示、追加、編集、削除
4. タグ削除は紐づく動画がない場合のみ可能
```

### 2.4. ユーザー管理フロー

**要件ID:** REQ-4-1

```
【ユーザー一覧表示】
1. 管理者ダッシュボードから「ユーザー管理」クリック
2. ユーザー管理ページ（/admin/users）へ遷移
3. ユーザー一覧表示
   - ユーザー名
   - メールアドレス
   - 登録日
   - 最終ログイン日
   - 視聴動画数
   - 操作ボタン（詳細/削除）
4. ページネーション対応（1ページ50件）
5. 検索・フィルタリング機能

【ユーザー詳細表示】
1. ユーザー管理ページから「詳細」ボタンクリック
2. ユーザー詳細ページ（/admin/users/{id}）へ遷移
3. ユーザー情報表示
   - 基本プロフィール情報
   - 視聴履歴一覧
   - 登録日・最終ログイン日

【ユーザー削除】
1. ユーザー管理ページから「削除」ボタンクリック
2. 削除確認ダイアログ表示「このユーザーを削除してもよろしいですか？」
3. 「削除」ボタンクリック
4. ユーザーアカウントと関連データ削除
5. 視聴履歴も同時削除
6. 削除成功 → ユーザー管理ページに留まる
```

## 3. エラー・例外処理フロー

### 3.1. 認証・認可エラー

```
【未認証アクセス】
- 条件: ログインが必要なページに未ログイン状態でアクセス
- 処理: ログインページ（/login）へリダイレクト
- メッセージ: 「ログインが必要です」

【権限エラー】
- 条件: 管理者専用ページに一般ユーザーがアクセス
- 処理: 前の画面にリダイレクト
- メッセージ: なし（権限エラーメッセージは表示しない）

【セッション期限切れ】
- 条件: セッション有効期限（24時間）が切れた状態でアクセス
- 処理: ログインページへリダイレクト
- メッセージ: 「セッションが期限切れです。再度ログインしてください」
```

### 3.2. バリデーションエラー

**注**: バリデーション実装方針の詳細は`tech.md`の「バリデーション実装方針」セクションを参照してください。このプロジェクトでは二段階バリデーション戦略（フロントエンド + バックエンド）を採用しています。

```
【フォーム入力エラー】
- 条件: 必須項目が未入力、形式が不正、サイズ超過など
- 処理: 入力フォームに留まる
- 表示: 各入力項目の下にエラーメッセージ表示（日本語、ピリオド付き）
  - 例: 「名前は必須です。」
  - 例: 「有効なメールアドレスを入力してください。」
  - 例: 「パスワードは8文字以上で入力してください。」
  - 例: 「ファイルサイズは最大5MBです。」

【ファイルアップロードエラー】
- 条件: ファイル形式が不正、サイズ超過
- 処理: アップロードフォームに留まる
- 表示: エラーメッセージ表示
  - 例: 「MP4形式のみアップロード可能です。」
  - 例: 「ファイルサイズは最大2GBです。」
```

### 3.3. データ読み込みエラー

```
【動画が見つからない】
- 条件: 存在しない動画IDにアクセス
- 処理: 404エラーページ表示
- メッセージ: 「動画が見つかりません」

【データベース接続エラー】
- 条件: データベース接続失敗
- 処理: 500エラーページ表示
- メッセージ: 「サーバーエラーが発生しました。しばらくしてから再度お試しください」
```

## 4. 共通操作フロー

### 4.1. ログアウトフロー

```
【全ユーザー共通】
1. ヘッダーから「ログアウト」ボタンクリック
2. セッション情報削除
3. トップページ（/）へリダイレクト
4. 「ログアウトしました」メッセージ表示
```

### 4.2. セッション管理

```
【セッション維持】
- ログイン状態は24時間維持
- アクティブ時は自動延長
- 非アクティブ24時間で自動ログアウト

【セッション切れ時】
- ログインページへ自動リダイレクト
- メッセージ: 「セッションが期限切れです。再度ログインしてください」
- ログイン後、元のページに戻る（リダイレクト先保存）
```

## 5. 画面遷移パターン

### 5.1. 一般ユーザー画面遷移

```
トップページ（/）
├─ 新規登録（/register） → 登録完了 → ダッシュボード（/dashboard）
├─ ログイン（/login） → ダッシュボード（/dashboard）
└─ ダッシュボード（/dashboard）
   ├─ 動画一覧（/videos）
   │  └─ 動画詳細（/videos/{id}）
   │     └─ 関連動画クリック → 別の動画詳細
   ├─ プロフィール（/profile）
   │  ├─ プロフィール編集（/profile/edit） → プロフィール
   │  └─ パスワード変更（/profile/password） → プロフィール
   └─ ログアウト → トップページ（/）
```

### 5.2. 管理者画面遷移

```
管理者ログインページ（/admin/login） → 管理者ダッシュボード（/admin/dashboard）
├─ 動画アップロード（/admin/videos/create） → 動画管理
├─ 動画管理（/admin/videos）
│  ├─ 動画編集（/admin/videos/{id}/edit） → 動画管理
│  └─ 動画削除 → 動画管理（削除後も同じページ）
├─ カテゴリ管理（/admin/categories）
│  ├─ カテゴリ追加 → カテゴリ管理
│  ├─ カテゴリ編集 → カテゴリ管理
│  └─ カテゴリ削除 → カテゴリ管理
├─ タグ管理（/admin/tags）
│  ├─ タグ追加 → タグ管理
│  ├─ タグ編集 → タグ管理
│  └─ タグ削除 → タグ管理
├─ ユーザー管理（/admin/users）
│  ├─ ユーザー詳細（/admin/users/{id}） → ユーザー管理
│  └─ ユーザー削除 → ユーザー管理
└─ ログアウト → トップページ（/）
```

## 6. パフォーマンス考慮事項

### 6.1. 動画読み込みパフォーマンス

- 動画プレーヤー表示開始まで3秒以内
- 100人同時アクセス対応
- 動画ファイルはLaravel Storageで管理（MVP段階ではCDN未使用）

### 6.2. レスポンス性能

- 画面遷移は2秒以内
- 動画一覧表示は2秒以内
- 検索結果表示は1秒以内
- Ajax処理（公開/非公開切替）は500ミリ秒以内

### 6.3. データベースパフォーマンス

- ページネーション対応（一般ユーザー: 1ページ20件、管理者: 1ページ50件）
- N+1問題の回避（Eager Loading使用）
- 適切なインデックス設定

## 7. 将来的な拡張ワークフロー

### 7.1. 第2フェーズ予定機能のワークフロー

**有料動画管理機能**
- 動画ごとの価格設定フロー
- 購入フロー（Stripe/PayPal決済連携）
- 購入履歴管理フロー
- 領収書発行フロー

**サブスクリプション機能**
- 月額プラン登録フロー
- プラン変更フロー
- 請求管理フロー
- 自動更新処理フロー

**グループ管理機能**
- グループ作成フロー
- ユーザーのグループ割り当てフロー
- グループごとの動画公開制御フロー

**招待制機能**
- 招待リンク生成フロー
- 招待メール送信フロー
- 招待状況確認フロー

**視聴制限機能**
- 視聴期限設定フロー
- 視聴回数制限設定フロー
- 同時視聴数制限設定フロー

**メール認証機能**
- 登録時認証メール送信フロー
- メールリンク認証フロー
- 認証メール再送信フロー

**二段階認証機能**
- 二段階認証有効化フロー（SMS認証、Google Authenticator）
- バックアップコード生成フロー

**全文検索機能**
- Elasticsearch/Algolia導入による高速検索フロー
- 検索候補自動表示フロー
