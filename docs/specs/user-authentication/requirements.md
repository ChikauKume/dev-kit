# 要件定義書: ユーザー認証機能

## 機能概要

ユーザー認証機能は、動画配信プラットフォームへのアクセス制御を実現します。一般ユーザーが自由に登録でき、管理者と一般ユーザーの権限を明確に分離します。

**関連要件ID**: REQ-1-1（ユーザー登録）, REQ-1-2（ログイン・ログアウト）, REQ-1-3（パスワードリセット）

**スコープ外**:
- プロフィール管理機能（将来実装予定）
- プロフィール画像アップロード・管理機能（将来実装予定）

## 要件

### 要件1: ユーザー登録（REQ-1-1）

**ユーザーストーリー**: 動画配信プラットフォームを利用したい人として、メールアドレスと名前とパスワードで簡単にアカウントを作成し、すぐに動画視聴を開始したい。

#### 受け入れ基準

1. ユーザーが登録フォームで必須項目を入力すると、システムは入力内容を検証する
   - 名前（必須、最大255文字）
   - メールアドレス（必須、メールアドレス形式）
   - パスワード（必須、8文字以上、英数字混在）

2. メールアドレスが既に登録済みの場合、「このメールアドレスは既に使用されています」とエラーを表示する

3. パスワードが条件を満たさない場合、「パスワードは8文字以上で英数字を含めてください」とエラーを表示する

4. 検証が成功すると、パスワードをBcryptでハッシュ化して保存し、自動ログイン後にダッシュボードへリダイレクトする

### 要件2: ログイン・ログアウト（REQ-1-2）

**ユーザーストーリー**: 登録済みユーザーとして、メールアドレスとパスワードでログインし、使用後は確実にログアウトしたい。

#### 受け入れ基準

**ログイン**:
1. メールアドレスとパスワードで認証する
2. 認証失敗時は「メールアドレスまたはパスワードが正しくありません」とエラーを表示する
3. 認証成功時はセッション（有効期限24時間）を作成し、ダッシュボードへリダイレクトする

**ログアウト**:
1. ログアウトボタンクリックでセッションを破棄する
2. ログアウト後はトップページへリダイレクトする
3. ログアウト後に保護された画面にアクセスすると、ログイン画面にリダイレクトする

### 要件3: パスワードリセット（REQ-1-3）

**ユーザーストーリー**: パスワードを忘れたユーザーとして、メールアドレスで本人確認を行い、新しいパスワードを設定したい。

#### 受け入れ基準

1. メールアドレスを入力すると、リセットトークンを生成し、リセットリンクを含むメールを送信する
2. リセットリンクをクリックすると、トークンの有効性を確認する
3. トークンが無効または期限切れの場合は「このリンクは無効または期限切れです」とエラーを表示する
4. 新しいパスワードを入力すると、Bcryptでハッシュ化して保存し、トークンを削除する

### 要件4: 権限管理

**ユーザーストーリー**: 管理者として、動画管理画面や統計情報画面にアクセスし、一般ユーザーにはアクセスを制限したい。

#### 受け入れ基準

1. ユーザー登録時はデフォルトで「一般ユーザー」権限を付与する
2. 管理者専用画面にアクセス時は管理者権限を確認する
3. 一般ユーザーが管理者専用画面にアクセスすると、前の画面にリダイレクトする（権限エラーメッセージは表示しない）

### 要件5: セッション管理

**ユーザーストーリー**: セキュリティを重視するユーザーとして、一定時間操作をしなかった場合は自動的にログアウトしてほしい。

#### 受け入れ基準

1. ログイン時はセッションの有効期限を24時間に設定する
2. ユーザーが操作を行うとセッションの有効期限を更新する
3. セッションの有効期限が切れると、次回アクセス時にログイン画面にリダイレクトする

## 非機能要件

全体的な非機能要件（性能、セキュリティ、信頼性）については [tech.md](../../steering/tech.md) を参照。

### この機能固有の制約

- **総当たり攻撃対策**: 同一IPアドレスからのログイン試行は5回まで、その後15分間ロック
- **ログ出力**: 認証失敗・成功、権限エラーをログに記録（ユーザーID、IPアドレスを含む）
