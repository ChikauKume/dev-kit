# 設計書: ユーザー認証機能

## 概要

**何ができる？**
- ユーザー登録（3ステップ: 入力 → 確認 → 完了）
- ログイン
- ログアウト

**スコープ外**:
- パスワードリセット → `user-password-reset/design.md` 参照
- プロフィール管理（将来実装予定）

**関連要件ID**: REQ-1-1（ユーザー登録）, REQ-1-2（ログイン・ログアウト）

---

## 画面フロー

### ユーザー登録フロー（3ステップ）
```
/signup (FormPage)
  │
  │ [入力内容]
  │ - 名前
  │ - メールアドレス
  │ - 電話番号（任意）
  │ - パスワード
  │ - パスワード確認
  │ - 利用規約同意（必須）
  │
  ↓ 「登録内容を確認」ボタン
  │
/signup/confirm (DetailPage)
  │
  │ [表示内容]
  │ - 名前
  │ - メールアドレス
  │ - 電話番号
  │
  │ [操作]
  │ - 「戻る」ボタン → /signup（入力データ保持）
  │ - 「登録する」ボタン → データベース登録
  │
  ↓ 「登録する」ボタン
  │
/signup/complete (MessagePage)
  │
  │ [表示内容]
  │ - 「登録が完了しました」
  │
  ↓ 「ログイン画面へ」ボタン
  │
/login
```

### ログイン・ログアウトフロー
```
/login (LoginPage)
  │
  │ [入力内容]
  │ - メールアドレス
  │ - パスワード
  │
  ↓ 「ログイン」ボタン
  │
/dashboard (DashboardPage)
  │
  │ [表示内容]
  │ - 「ようこそ、{名前}さん」
  │
  │ [操作]
  │ - ユーザーメニュー → 「ログアウト」
  │
  ↓ 「ログアウト」ボタン
  │
/login（セッション無効化）
```

---

## 画面一覧

| 画面 | URL | 何ができる？ | 使用テンプレート | 認証 |
|-----|-----|----------|--------------|-----|
| ログイン | `/login` | メール・パスワードでログイン | LoginPage | 不要 |
| 新規登録 | `/signup` | ユーザー情報を入力 | FormPage | 不要 |
| 登録確認 | `/signup/confirm` | 入力内容を確認、戻る/登録 | DetailPage | 不要 |
| 登録完了 | `/signup/complete` | 完了メッセージ表示 | MessagePage | 不要 |
| ダッシュボード | `/dashboard` | ユーザー名表示のみ | DashboardPage | 必須 |
| 404エラー | - | ページが見つかりません | Error404Page | 不要 |
| 500エラー | - | サーバーエラー | Error500Page | 不要 |

---

## 入力項目とバリデーション

### 新規登録フォーム（/signup）

| 項目 | 必須 | バリデーション | エラーメッセージ例 |
|-----|------|--------------|----------------|
| 名前 | ✅ | 2-255文字 | "名前は2文字以上で入力してください。" |
| メール | ✅ | メール形式、重複禁止、255文字以下 | "このメールアドレスは既に登録されています。" |
| 電話 | ❌ | 半角数字、0始まり10-11桁、ハイフンなし | "電話番号は半角数字10-11桁で入力してください。" |
| パスワード | ✅ | 8-255文字、英字と数字を各1文字以上含む | "パスワードは英字と数字を含む8文字以上で入力してください。" |
| パスワード確認 | ✅ | パスワードと一致 | "パスワードが一致しません。" |
| 利用規約同意 | ✅ | チェック必須 | "利用規約に同意してください。" |

### ログインフォーム（/login）

| 項目 | 必須 | バリデーション | エラーメッセージ例 |
|-----|------|--------------|----------------|
| メール | ✅ | メール形式 | "有効なメールアドレスを入力してください。" |
| パスワード | ✅ | 必須 | "パスワードを入力してください。" |

**認証失敗時**: "メールアドレスまたはパスワードが正しくありません。"

---

## 特記事項

### 確認画面の「戻る」動線
- 確認画面から戻った場合、**入力データを保持**（名前、メール、電話）
- **パスワードは再入力必須**（セキュリティ上、セッションに平文保存しない）
- 実装: セッションに保存された `old` データを使用

### 電話番号の入力処理
- **フロントエンド**: 全角数字 → 半角数字に自動変換（onChange/onBlurイベント）
- **バックエンド**: 半角数字のみ許可（全角数字・ハイフンはバリデーションエラー）

### ダッシュボード
- **認証必須**: middleware: auth
- **表示内容**: ログイン中のユーザー名を右上に動的表示
- **スコープ**: この機能に含む（ログイン後の最初のページ）
- **実装**: DashboardPageテンプレートにuserNameプロパティを渡す

**Controller実装例**:
```php
return Inertia::render('Dashboard', [
    'userName' => auth()->user()->name
]);
```


---

## テストケース

**詳細定義**:
- PHPUnit: `tests/phpunit.yaml`
- E2E: `tests/e2e.yaml`

### E2Eシナリオ概要（13件）

**正常系（6件）**:
- E2E-001: ユーザー登録フロー（入力 → 確認 → 完了）
- E2E-002: 確認画面から登録画面に戻る（入力データ保持確認）
- E2E-003: ログイン・ダッシュボード表示（右上ユーザー名確認）
- E2E-004: ログアウトとセッション無効化
- E2E-008: 電話番号なしでの登録（任意項目確認）
- E2E-009: 全角数字→半角数字自動変換（フロントエンド変換確認）

**異常系（7件）**:
- E2E-005: バリデーションエラー表示
- E2E-006: ログイン失敗
- E2E-007: メールアドレス重複チェック（uniqueバリデーション確認）
- E2E-010: 確認画面への直接アクセス拒否（セッションガード）
- E2E-011: 完了画面への直接アクセス拒否（セッションガード）
- E2E-012: 認証済みユーザーのログイン画面アクセス（guestミドルウェア）
- E2E-013: 認証済みユーザーの登録画面アクセス（guestミドルウェア）

---

## 参照ドキュメント

**共通アーキテクチャ**:
- モジュール構造: `dev-kit/docs/architecture/modules.md`
- テスト戦略: `dev-kit/docs/architecture/testing.md`
- エラー処理: `dev-kit/docs/architecture/error-handling.md`
- データベース: `dev-kit/docs/architecture/db.md`
