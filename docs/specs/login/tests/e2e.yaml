# ===================================================================
# E2E テストケース定義(Playwright) - ログイン機能
# ===================================================================
# ⚠️ YAML記述上の重要な注意事項:
#   1. 長い文字列: "あ" * 255 ではなく実際に255文字分記述する
#   2. セレクタ: 'button:has-text("登録")' は自動でgetByRole()に変換される
#   3. text=セレクタ: 'text="エラー"' は自動でgetByText()に変換される
#   4. ハッシュ値: $ を含む値はシングルクォートで囲む(例: '$2y$10$...')
# ===================================================================

spec_name: login
test_type: e2e
framework: playwright

config:
  video: on
  slow_mo: 750
  base_url: http://127.0.0.1
  timeout: 30000

scenarios:
  - id: E2E-001
    name: ログイン・ダッシュボード表示(正常系)
    page_name: Login
    category: normal
    description: |
      登録済みユーザーがログインし、ダッシュボードに右上のユーザーメニューにユーザー名が表示されることを確認。
    prerequisites:
      - "テストユーザーが登録されていること(email: test@example.com, password: Password123!)"
    steps:
      - action: navigate
        url: /login
        description: ログイン画面にアクセス
      - action: type
        selector: input[name="email"]
        value: "test@example.com"
        description: メールアドレスを入力
      - action: type
        selector: input[name="password"]
        value: "Password123!"
        description: パスワードを入力
      - action: click
        selector: button[type="submit"]
        description: ログインボタンをクリック
      - action: wait_for_navigation
        url: /dashboard
        description: ダッシュボードに遷移することを確認
      - action: assert_text_contains
        selector: .user-button
        expected: "山田 太郎"
        description: 右上ユーザーメニューにユーザー名が表示されることを確認
    expected_results:
      - ログインが正常に完了すること
      - ダッシュボードに遷移すること
      - ダッシュボードにユーザー名が表示されること
    validations:
      - session:
          authenticated: true
          user_email: "test@example.com"

  - id: E2E-002
    name: ログアウトとセッション無効化(正常系)
    page_name: Dashboard
    category: normal
    description: |
      ログイン済みユーザーがログアウトし、セッションが無効化されることを確認。
      ダッシュボードへのアクセスがブロックされることもテスト。
    prerequisites:
      - テストユーザーでログイン済みであること
      - ダッシュボードに表示されていること
    steps:
      - action: navigate
        url: /dashboard
        description: ダッシュボードにアクセス
      - action: click
        selector: button:has-text("ログアウト")
        description: ログアウトボタンをクリック
      - action: wait_for_navigation
        url: /login
        description: ログイン画面にリダイレクトされることを確認
      - action: navigate
        url: /dashboard
        description: ダッシュボードに直接アクセスを試行
      - action: wait_for_navigation
        url: /login
        description: ログイン画面にリダイレクトされることを確認(認証が無効化されている)
    expected_results:
      - ログアウトが正常に完了すること
      - ログイン画面にリダイレクトされること
      - セッションが無効化されること
      - ダッシュボードへのアクセスがブロックされること
    validations:
      - session:
          authenticated: false

  - id: E2E-003
    name: ログイン失敗(異常系)
    page_name: Login
    category: error
    description: |
      誤った認証情報でログインを試行した場合、エラーメッセージが表示され、
      ログインできないことを確認。
    prerequisites:
      - ログイン画面にアクセスできること
    steps:
      - action: navigate
        url: /login
        description: ログイン画面にアクセス
      - action: type
        selector: input[name="email"]
        value: "nonexistent@example.com"
        description: 存在しないメールアドレスを入力
      - action: type
        selector: input[name="password"]
        value: "WrongPassword123!"
        description: 誤ったパスワードを入力
      - action: click
        selector: button[type="submit"]
        description: ログインボタンをクリック
      - action: wait
        duration: 1000
        description: エラーメッセージの表示を待つ
      - action: assert_url
        expected: /login
        description: ログイン画面から遷移しないことを確認
      - action: assert_visible
        selector: text="メールアドレスまたはパスワードが正しくありません"
        description: 認証エラーメッセージが表示されることを確認
    expected_results:
      - ログインが失敗すること
      - ログイン画面から遷移しないこと
      - 認証エラーメッセージが表示されること
      - ダッシュボードにアクセスできないこと
    validations:
      - session:
          authenticated: false
      - database:
          table: failed_login_attempts
          conditions:
            email: "nonexistent@example.com"
          assertion: record_created

  - id: E2E-004
    name: 認証済みユーザーのログイン画面アクセス(異常系)
    page_name: Login
    category: error
    description: |
      ログイン済みユーザーが /login にアクセスした場合、
      /dashboard にリダイレクトされることを確認。
      guest ミドルウェアの動作テスト。
    prerequisites:
      - テストユーザーでログイン済みであること
    steps:
      - action: navigate
        url: /dashboard
        description: ダッシュボードにアクセス(ログイン確認)
      - action: navigate
        url: /login
        description: ログイン画面にアクセスを試行
      - action: wait_for_navigation
        url: /dashboard
        description: ダッシュボードにリダイレクトされることを確認
    expected_results:
      - ログイン済みユーザーはログイン画面にアクセスできないこと
      - ダッシュボードにリダイレクトされること
    validations:
      - session:
          authenticated: true

  - id: E2E-005
    name: 404エラーページ表示(異常系)
    page_name: Error
    category: error
    description: |
      存在しないURLにアクセスした場合、404エラーページが正しく表示され、
      ホームに戻るボタンをクリックすると適切にリダイレクトされることを確認。
    prerequisites:
      - 404エラーページコンポーネントが実装されていること
    steps:
      - action: navigate
        url: /non-existent-page-12345
        description: 存在しないURLにアクセス
      - action: assert_visible
        selector: h2:has-text("お探しのページは見つかりませんでした")
        description: 404エラーページのヘッダーを確認
      - action: assert_visible
        selector: text=お探しのページは存在しないか、移動または削除された可能性があります
        description: エラーメッセージが表示されることを確認
      - action: assert_visible
        selector: button:has-text("ホームに戻る")
        description: ホームに戻るボタンが表示されることを確認
      - action: navigate
        url: /non-existent-page-67890
        description: 再度404ページを表示（未認証状態）
      - action: assert_visible
        selector: h2:has-text("お探しのページは見つかりませんでした")
        description: 404エラーページの表示を待機
      - action: click
        selector: button:has-text("ホームに戻る")
        description: ホームに戻るボタンをクリック
      - action: wait_for_navigation
        url: /login
        description: ログインページへリダイレクトされることを確認（未認証ユーザー）
    expected_results:
      - 存在しないURLで404エラーページが表示されること
      - エラーメッセージとヘッダーが適切に表示されること
      - ホームに戻るボタンが機能すること
      - 未認証ユーザーはログインページにリダイレクトされること
    validations:
      - http_status:
          code: 404
          message: "Not Found"

  - id: E2E-006
    name: エラーページ表示確認(異常系)
    page_name: Error
    category: error
    description: |
      存在しないページにアクセスした際に404エラーページが表示されること、
      サーバーエラー発生時に500エラーページが表示されることを確認。
    prerequisites:
      - エラーページコンポーネントが実装されていること
    steps:
      - action: navigate
        url: /nonexistent-page
        description: 存在しないページにアクセス
      - action: assert_visible
        selector: text="404"
        description: 404エラーページが表示されることを確認
      - action: assert_visible
        selector: text="ページが見つかりません"
        description: エラーメッセージが表示されることを確認
      - action: navigate
        url: /
        description: トップページに移動
      - action: assert_url
        expected: /
        description: トップページに正常に遷移することを確認
    expected_results:
      - 存在しないページで404エラーページが表示されること
      - エラーメッセージが適切に表示されること
      - トップページへのリンクが機能すること
    validations:
      - http_status:
          code: 404
          message: "Not Found"

  - id: E2E-007
    name: 500エラーページ表示(異常系)
    page_name: Error
    category: error
    description: |
      サーバーエラー発生時に500エラーページが正しく表示されることを確認。
      テスト用エンドポイントで意図的にエラーを発生させてテストする。
    prerequisites:
      - 500エラーページコンポーネントが実装されていること
      - テスト用エラーエンドポイント(/test-error)が実装されていること
    steps:
      - action: navigate
        url: /test-error
        description: テスト用エラーエンドポイントにアクセス（500エラーを発生させる）
      - action: assert_visible
        selector: h2:has-text("サーバーエラーが発生しました")
        description: 500エラーページのヘッダーを確認
      - action: assert_visible
        selector: text=サーバーで問題が発生しました。しばらく時間をおいてから再度お試しください。
        description: エラーメッセージが表示されることを確認
      - action: assert_visible
        selector: button:has-text("ホームに戻る")
        description: ホームに戻るボタンが表示されることを確認
    expected_results:
      - サーバーエラー発生時に500エラーページが表示されること
      - エラーメッセージが適切に表示されること
      - ホームに戻るボタンが表示されること
    validations:
      - http_status:
          code: 500
          message: "Internal Server Error"
